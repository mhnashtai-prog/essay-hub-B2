<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOLCANIC B2 | INTUITY Essay System</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --volcano: #FF4500;
            --magma: #C9A961;
            --charcoal: #1a1a1a;
            --slate: #2a2a2a;
            --ash: #e5e5e5;
            --smoke: #8e8e93;
            --ember: #636366;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 100%);
            color: var(--ash);
            height: 100vh;
            overflow: hidden;
        }

        /* ========== SIGNATURE HEADER ========== */
        .header {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            align-items: center;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid rgba(201, 169, 97, 0.2);
        }

        .header-center {
            text-align: center;
        }

        .header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--magma);
            margin: 0;
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 0.75rem;
            color: var(--smoke);
            margin: 0.25rem 0 0;
            font-weight: 500;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .header .author {
            font-size: 0.65rem;
            color: var(--ember);
            font-weight: 400;
            margin-top: 0.15rem;
        }

        /* ========== COMPACT TOGGLE SYSTEM ========== */
        .toggle-bar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 2rem;
            background: rgba(42, 42, 42, 0.3);
            border-bottom: 1px solid rgba(255, 69, 0, 0.15);
        }

        .toggle-group {
            display: flex;
            background: var(--slate);
            border-radius: 8px;
            padding: 0.25rem;
            gap: 0.25rem;
            border: 1px solid rgba(201, 169, 97, 0.15);
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: var(--smoke);
            padding: 0.4rem 0.9rem;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
        }

        .toggle-btn:hover {
            color: var(--magma);
        }

        .toggle-btn.active {
            background: rgba(201, 169, 97, 0.25);
            color: var(--magma);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.15);
        }

        .label-text {
            font-size: 0.65rem;
            color: var(--ember);
            margin-right: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            align-self: center;
        }

        /* ========== VOLCANIC LAYOUT ========== */
        .volcanic-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: calc(100vh - 120px);
            gap: 0;
        }

        /* ========== LEFT: PHRASEOLOGY MAGMA CHAMBER ========== */
        .magma-chamber {
            background: var(--slate);
            border-right: 2px solid var(--volcano);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .chamber-section {
            margin-bottom: 1.5rem;
        }

        .chamber-header {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--volcano);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 69, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phrase-count {
            font-size: 0.6rem;
            color: var(--smoke);
            font-weight: 600;
            background: rgba(255, 69, 0, 0.15);
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
        }

        .phrase-block {
            background: rgba(255, 69, 0, 0.05);
            border-left: 3px solid var(--volcano);
            padding: 0.75rem 1rem;
            margin-bottom: 0.65rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--ash);
        }

        .phrase-block:hover {
            background: rgba(255, 69, 0, 0.12);
            transform: translateX(5px);
            border-left-width: 4px;
        }

        .phrase-block:active {
            transform: translateX(3px);
            background: rgba(201, 169, 97, 0.15);
        }

        .structure-block {
            background: rgba(201, 169, 97, 0.08);
            border-left: 3px solid var(--magma);
            padding: 1rem;
            margin-bottom: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .structure-block:hover {
            background: rgba(201, 169, 97, 0.15);
            transform: translateX(5px);
        }

        .structure-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--magma);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .structure-text {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--ash);
            margin-bottom: 0.5rem;
        }

        .structure-pattern {
            font-size: 0.65rem;
            padding: 0.25rem 0.6rem;
            background: rgba(201, 169, 97, 0.2);
            color: var(--magma);
            border-radius: 3px;
            display: inline-block;
            font-weight: 600;
            font-style: italic;
        }

        /* ========== RIGHT: PRODUCTION CRATER ========== */
        .production-crater {
            display: flex;
            flex-direction: column;
            background: var(--charcoal);
        }

        /* Stage Navigator */
        .stage-nav {
            display: flex;
            background: var(--slate);
            border-bottom: 2px solid var(--volcano);
        }

        .stage {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            border-right: 1px solid rgba(255, 69, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.3);
        }

        .stage:last-child {
            border-right: none;
        }

        .stage.active {
            background: linear-gradient(180deg, rgba(255, 69, 0, 0.2), rgba(255, 69, 0, 0.05));
            border-bottom: 3px solid var(--volcano);
        }

        .stage.completed {
            background: rgba(80, 200, 120, 0.08);
        }

        .stage-number {
            font-size: 0.7rem;
            color: var(--smoke);
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .stage.active .stage-number {
            color: var(--volcano);
        }

        .stage-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--ash);
        }

        .stage.active .stage-name {
            color: var(--volcano);
        }

        /* Writing Canvas */
        .writing-canvas {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .section-composer {
            max-width: 800px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.4rem;
            color: var(--magma);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-guide {
            font-size: 0.85rem;
            color: var(--smoke);
            line-height: 1.7;
        }

        .writing-area {
            background: rgba(42, 42, 42, 0.5);
            border: 2px solid rgba(255, 69, 0, 0.25);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 320px;
            font-size: 1rem;
            line-height: 1.9;
            color: var(--ash);
            outline: none;
            resize: vertical;
            font-family: 'Inter', sans-serif;
            width: 100%;
            transition: all 0.3s ease;
        }

        .writing-area:focus {
            border-color: var(--volcano);
            background: rgba(42, 42, 42, 0.7);
            box-shadow: 0 0 25px rgba(255, 69, 0, 0.15);
        }

        /* Action Bar */
        .action-bar {
            padding: 1rem 2rem;
            background: var(--slate);
            border-top: 1px solid rgba(255, 69, 0, 0.25);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats {
            display: flex;
            gap: 2rem;
            font-size: 0.8rem;
        }

        .stat-item {
            color: var(--smoke);
        }

        .stat-value {
            color: var(--magma);
            font-weight: 700;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--smoke);
            color: var(--smoke);
        }

        .btn-secondary:hover {
            border-color: var(--magma);
            color: var(--magma);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--volcano), #FF6347);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 69, 0, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Bar */
        .progress-bar {
            height: 3px;
            background: rgba(255, 69, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--volcano), var(--magma));
            transition: width 0.4s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--charcoal);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--volcano);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--magma);
        }

        /* Loading & Error States */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 1rem;
            color: var(--smoke);
        }

        .error-state {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            text-align: center;
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .volcanic-container {
                grid-template-columns: 1fr;
            }

            .magma-chamber {
                display: none;
            }

            .header {
                grid-template-columns: 1fr;
            }

            .toggle-bar {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- ========== SIGNATURE HEADER ========== -->
    <div class="header">
        <div></div>
        <div class="header-center">
            <h1>INTUITY</h1>
            <p class="subtitle">Volcanic B2 Essay System</p>
            <p class="author">by Majid Nashtai</p>
        </div>
        <div></div>
    </div>

    <!-- ========== COMPACT TOGGLE SYSTEM ========== -->
    <div class="toggle-bar">
        <span class="label-text">Resources:</span>
        <div class="toggle-group" id="resourceToggle">
            <button class="toggle-btn active" data-resource="phrases">Phrases</button>
            <button class="toggle-btn" data-resource="structures">Structures</button>
            <button class="toggle-btn" data-resource="examples">Examples</button>
        </div>
        
        <span class="label-text" style="margin-left: 2rem;">Filter:</span>
        <div class="toggle-group" id="filterToggle">
            <button class="toggle-btn active" data-filter="all">All</button>
            <button class="toggle-btn" data-filter="stage">This Stage</button>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-fill" style="width: 0%"></div>
    </div>

    <!-- ========== VOLCANIC LAYOUT ========== -->
    <div class="volcanic-container">
        <!-- LEFT: PHRASEOLOGY MAGMA CHAMBER -->
        <div class="magma-chamber">
            <div id="resourcesContainer">
                <div class="loading-state">Loading resources...</div>
            </div>
        </div>

        <!-- RIGHT: PRODUCTION CRATER -->
        <div class="production-crater">
            <div class="stage-nav" id="stageNav">
                <!-- Stages loaded dynamically -->
            </div>

            <div class="writing-canvas">
                <div class="section-composer">
                    <div class="section-header">
                        <div class="section-title" id="sectionTitle">Loading...</div>
                        <div class="section-guide" id="sectionGuide">Please wait...</div>
                    </div>
                    <textarea class="writing-area" id="currentSection" placeholder="Click phrases on the left to build your essay..."></textarea>
                </div>
            </div>

            <div class="action-bar">
                <div class="stats">
                    <div class="stat-item">Words: <span class="stat-value" id="wordCount">0</span></div>
                    <div class="stat-item">Target: <span class="stat-value">30-40</span></div>
                    <div class="stat-item">Section: <span class="stat-value" id="sectionCount">-/-</span></div>
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-secondary" id="prevBtn" disabled>← Previous</button>
                    <button class="btn btn-primary" id="nextBtn">Next Section →</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // VOLCANIC B2 ESSAY SYSTEM - PRODUCTION
        // ========================================

        class VolcanicB2 {
            constructor() {
                this.phrases = {};
                this.structures = [];
                this.examples = [];
                this.stages = [];
                this.currentStage = 0;
                this.currentResource = 'phrases';
                this.currentFilter = 'all';
                this.essayData = [];
            }

            async init() {
                try {
                    await this.loadData();
                    this.setupUI();
                    this.attachListeners();
                    this.loadStage();
                } catch (error) {
                    this.showError('Failed to load system. Check that JSON files are in correct folders.');
                    console.error('Init error:', error);
                }
            }

            async loadData() {
                // Load B2 phrases
                const phrasesData = await fetch('phrases/B2-level.json').then(r => r.json());
                this.phrases = phrasesData.categories;

                // Load B2 structures
                const structuresData = await fetch('samples/advanced-structures-b2.json').then(r => r.json());
                this.structures = this.parseStructures(structuresData);

                // Load B2 essay sections (examples)
                const examplesData = await fetch('samples/B2-level.json').then(r => r.json());
                this.examples = examplesData.categories;

                // Define B2-specific stages
                this.stages = [
                    {
                        name: "Opening",
                        title: "Introduction: Opening Statement",
                        guide: "Start with a general statement about the topic. Make it interesting but clear.",
                        phraseCategories: ["generalisation", "opinion"],
                        structureTypes: ["adjective_focus", "adverb_focus"],
                        target: "30-40 words"
                    },
                    {
                        name: "Your View",
                        title: "Introduction: Your Opinion",
                        guide: "State YOUR opinion clearly. What do you think about this topic?",
                        phraseCategories: ["opinion", "agreement"],
                        structureTypes: ["combined_adjective_gerund_consequence"],
                        target: "25-35 words"
                    },
                    {
                        name: "Reason 1",
                        title: "Body: First Main Point",
                        guide: "Give your strongest reason. Support it with an example or explanation.",
                        phraseCategories: ["cause", "adding", "facts"],
                        structureTypes: ["cause_and_effect", "participle_of_result"],
                        target: "40-50 words"
                    },
                    {
                        name: "Reason 2",
                        title: "Body: Second Main Point",
                        guide: "Add another reason or show the other side. Use contrast words.",
                        phraseCategories: ["contrasting", "conceding", "examples"],
                        structureTypes: ["balance_and_consequence"],
                        target: "40-50 words"
                    },
                    {
                        name: "Closing",
                        title: "Conclusion: Sum It Up",
                        guide: "Summarize your main points and restate your opinion strongly.",
                        phraseCategories: ["concluding", "opinion"],
                        structureTypes: ["adverb_focus"],
                        target: "30-40 words"
                    }
                ];

                this.essayData = new Array(this.stages.length).fill('');
            }

            parseStructures(data) {
                if (!data.structures) return [];
                
                return Object.entries(data.structures).map(([key, examples]) => ({
                    type: key,
                    category: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    examples: examples,
                    pattern: this.inferPattern(examples[0], key)
                }));
            }

            inferPattern(example, type) {
                const patterns = {
                    'adjective_focus': 'Adjective + noun + verb',
                    'adverb_focus': 'Subject + adverb + verb',
                    'participle_of_result': 'Main clause, causing/creating...',
                    'combined_adjective_gerund_consequence': 'Adjective, subject + verb',
                    'causal_participle_phrase': 'Having + past participle, main clause',
                    'present_participle_consequence': 'Gerund phrase + consequence',
                    'balance_and_consequence': 'While X, Y'
                };
                return patterns[type] || 'Standard B2 pattern';
            }

            setupUI() {
                const stageNav = document.getElementById('stageNav');
                stageNav.innerHTML = this.stages.map((stage, idx) => `
                    <div class="stage ${idx === 0 ? 'active' : ''}" data-stage="${idx}">
                        <div class="stage-number">${String(idx + 1).padStart(2, '0')}</div>
                        <div class="stage-name">${stage.name}</div>
                    </div>
                `).join('');
            }

            loadStage() {
                const stage = this.stages[this.currentStage];
                
                document.getElementById('sectionTitle').textContent = stage.title;
                document.getElementById('sectionGuide').textContent = stage.guide;
                
                const writingArea = document.getElementById('currentSection');
                writingArea.value = this.essayData[this.currentStage];
                writingArea.placeholder = `${stage.guide}\n\nTarget: ${stage.target}`;
                
                this.loadResources();
                this.updateNav();
                this.updateStats();
                
                writingArea.focus();
            }

            loadResources() {
                const container = document.getElementById('resourcesContainer');
                const stage = this.stages[this.currentStage];
                
                if (this.currentResource === 'phrases') {
                    this.displayPhrases(container, stage);
                } else if (this.currentResource === 'structures') {
                    this.displayStructures(container, stage);
                } else if (this.currentResource === 'examples') {
                    this.displayExamples(container, stage);
                }
            }

            displayPhrases(container, stage) {
                let categoriesToShow = this.currentFilter === 'stage' 
                    ? stage.phraseCategories 
                    : Object.keys(this.phrases);

                let html = '';
                
                categoriesToShow.forEach(cat => {
                    if (!this.phrases[cat]) return;
                    
                    const phrases = this.phrases[cat];
                    html += `
                        <div class="chamber-section">
                            <div class="chamber-header">
                                ${cat.replace(/_/g, ' ')}
                                <span class="phrase-count">${phrases.length}</span>
                            </div>
                            ${phrases.map(phrase => `
                                <div class="phrase-block" data-text="${phrase}">
                                    ${phrase}
                                </div>
                            `).join('')}
                        </div>
                    `;
                });

                container.innerHTML = html || '<div class="loading-state">No phrases available</div>';
                
                this.attachResourceHandlers();
            }

            displayStructures(container, stage) {
                let structuresToShow = this.structures;
                
                if (this.currentFilter === 'stage') {
                    structuresToShow = this.structures.filter(s => 
                        stage.structureTypes.includes(s.type)
                    );
                }

                let html = structuresToShow.map(struct => `
                    <div class="structure-block">
                        <div class="structure-title">${struct.category}</div>
                        <div class="structure-text">${struct.examples[0]}</div>
                        <div class="structure-pattern">${struct.pattern}</div>
                    </div>
                `).join('');

                container.innerHTML = html || '<div class="loading-state">No structures available</div>';
                
                this.attachResourceHandlers();
            }

            displayExamples(container, stage) {
                // Map stage index to example section
                const sectionMap = {
                    0: 'introductions',
                    1: 'introductions',
                    2: 'body',
                    3: 'body',
                    4: 'conclusion'
                };

                const section = sectionMap[this.currentStage];
                const sectionData = this.examples[section];

                if (!sectionData) {
                    container.innerHTML = '<div class="loading-state">No examples available</div>';
                    return;
                }

                let html = '';
                
                Object.entries(sectionData).forEach(([category, items]) => {
                    html += `
                        <div class="chamber-section">
                            <div class="chamber-header">
                                ${category.replace(/_/g, ' ')}
                                <span class="phrase-count">${items.length}</span>
                            </div>
                            ${items.map(item => `
                                <div class="phrase-block" data-text="${item}">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    `;
                });

                container.innerHTML = html;
                
                this.attachResourceHandlers();
            }

            attachResourceHandlers() {
                document.querySelectorAll('.phrase-block, .structure-block').forEach(block => {
                    block.addEventListener('click', () => {
                        const text = block.dataset.text || block.querySelector('.structure-text')?.textContent;
                        if (text) this.insertText(text);
                    });
                });
            }

            insertText(text) {
                const writingArea = document.getElementById('currentSection');
                const cursorPos = writingArea.selectionStart;
                const currentText = writingArea.value;
                const before = currentText.substring(0, cursorPos);
                const after = currentText.substring(cursorPos);
                
                writingArea.value = before + text + ' ' + after;
                writingArea.focus();
                
                const newPos = cursorPos + text.length + 1;
                writingArea.setSelectionRange(newPos, newPos);
                
                this.essayData[this.currentStage] = writingArea.value;
                this.updateStats();
            }

            updateNav() {
                document.querySelectorAll('.stage').forEach((el, idx) => {
                    el.classList.remove('active', 'completed');
                    if (idx === this.currentStage) el.classList.add('active');
                    if (idx < this.currentStage) el.classList.add('completed');
                });

                document.getElementById('prevBtn').disabled = this.currentStage === 0;
                
                const nextBtn = document.getElementById('nextBtn');
                nextBtn.textContent = this.currentStage === this.stages.length - 1 
                    ? 'Finish Essay 🎉' 
                    : 'Next Section →';
            }

            updateStats() {
                const writingArea = document.getElementById('currentSection');
                const words = writingArea.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                document.getElementById('wordCount').textContent = words;
                document.getElementById('sectionCount').textContent = `${this.currentStage + 1}/${this.stages.length}`;
                
                const completed = this.essayData.filter(s => s.trim().length > 0).length;
                const percent = (completed / this.stages.length) * 100;
                document.querySelector('.progress-fill').style.width = percent + '%';
            }

            attachListeners() {
                // Writing area
                const writingArea = document.getElementById('currentSection');
                writingArea.addEventListener('input', () => {
                    this.essayData[this.currentStage] = writingArea.value;
                    this.updateStats();
                });

                // Navigation
                document.getElementById('prevBtn').addEventListener('click', () => {
                    if (this.currentStage > 0) {
                        this.currentStage--;
                        this.loadStage();
                    }
                });

                document.getElementById('nextBtn').addEventListener('click', () => {
                    if (this.currentStage < this.stages.length - 1) {
                        this.currentStage++;
                        this.loadStage();
                    } else {
                        this.finishEssay();
                    }
                });

                // Stage clicking
                document.querySelectorAll('.stage').forEach((el, idx) => {
                    el.addEventListener('click', () => {
                        this.currentStage = idx;
                        this.loadStage();
                    });
                });

                // Resource toggle
                document.querySelectorAll('#resourceToggle .toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('#resourceToggle .toggle-btn').forEach(b => 
                            b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentResource = btn.dataset.resource;
                        this.loadResources();
                    });
                });

                // Filter toggle
                document.querySelectorAll('#filterToggle .toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('#filterToggle .toggle-btn').forEach(b => 
                            b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentFilter = btn.dataset.filter;
                        this.loadResources();
                    });
                });
            }

            finishEssay() {
                const fullEssay = this.essayData.filter(s => s.trim()).join('\n\n');
                const totalWords = fullEssay.trim().split(/\s+/).filter(w => w.length > 0).length;
                
                const blob = new Blob([
                    `INTUITY B2 Essay\n` +
                    `Generated: ${new Date().toLocaleString()}\n` +
                    `${'='.repeat(50)}\n\n` +
                    fullEssay +
                    `\n\n${'='.repeat(50)}\n` +
                    `Total Words: ${totalWords}\n` +
                    `Target: 190-200 words`
                ], { type: 'text/plain' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `B2_Essay_${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('🌋 Your B2 essay has erupted! Download complete.');
            }

            showError(message) {
                document.getElementById('resourcesContainer').innerHTML = 
                    `<div class="error-state">${message}</div>`;
            }
        }

        // Launch the volcano
        const volcanic = new VolcanicB2();
        volcanic.init();
    </script>
</body>
</html>
